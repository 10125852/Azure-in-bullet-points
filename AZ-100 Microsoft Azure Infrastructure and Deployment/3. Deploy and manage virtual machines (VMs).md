# Deploy and manage virtual machines (VMs)

- **VM Concepts**
  - Storage resource provider (SRP)
    - Disks (blob)
    - Storage account
  - Compute resource provider (CRP)
    - VM's
  - Networking resource provider (NRP)
    - NIC's, IP addresses, subnets load balancers..

- **Common VM Operations**
  - You can manage VM with ARM REST APIs, Azure Portal, Powershell, CLI and SDK's.
  - ***Move VM***
    - üí° You can move virtual machines with the managed disks & in Availability Zones across subscriptions and VM's.
      - ‚ùó Not supported:
        - Virtual Machine Scale Sets.
        - Virtual machines created from Marketplace resources with plans attached
      - ‚ùó To move a virtual machine with a network interface card, you must move all dependent resources. You must move the virtual network for the network interface card, all other network interface cards for the virtual network, and the VPN gateways.
    - Virtual networks (classic) can't be moved.
  - ***Stop***
    - **Deallocation**: If you shut down VM inside VM, Azure still keeps the resources, deallocate instead
    - **Auto shutdown**: VM blade in Portal
  - ***Remove a VM***
    - Deleting VM doesn't remove dependencies such as NICs, storages, OS/data disks, IP addresses
    - üí° Delete resource group instead, or use taxonomic tags
    - PowerShell or CLI allows you to keep OS and/or Data disks
  - **Azure VM Extensions**
    - Extends VM capabilities
    - Requires Azure VM Agent (different for Windows or Linux)
      - Marketplace images already have it
      - For lift & shift, install agent first before uploading to cloud
    - **VM Access**
      - Backdoor to reset VM password reset
      - Allows to modify RDP/SSH configurations
    - **VM Backup**
      - Allows to back-up VM's and configurations to recovery vault
    - **Custom Script**
      - Allows Desired State Configuration (DSC)
        - You can script in Linux (bash), Windows (PowerShell)
        - Puppet, chef etc
    - **Microsoft Monitoring Agent**
      - Onboards VM in Log Analytics

- **VM Sizing**
  - Allows vertical scaling, e.g. CPU, RAM and other resources
  - ‚ùó Resizing requires rebooting VM.
  - **Azure Compute Unit (ACU)**
    - Standardization without any hardware details
    - 100 ACU = Small (Standard A1) VM
      - A = Family
      - 1 = Size (versioned)
    - DS_V3 = 160-190 ACU
    - Good for estimating for lift and shift.
    - AS you raise APU, per minute runtime charges increases.
  - Types

    | Type | Sizes | Description |
    | ---- | ----- | ----------- |
    | General purpose | B, Dsv3, Dv3, DSv2, Dv2, DS, D, Av2, A0-7 | Balanced CPU-to-memory ratio. Ideal for testing and development, small to medium databases, and low medium traffic web servers. |
    | Compute optimized | Fsv2, Fs, F | High CPU-to-memory ratio. Good for medium traffic web servers, network appliances, batch processes, and application servers. |
    | Memory optimized | Esv3, Ev3, M, GS, G, DSv2, DS, Dv2, D | High memory-to-CPU ratio. Great for relational database servers, medium to large caches, and in-memory analytics. |
    | Storage optimized | Ls | High disk throughput and IO. Ideal for Big Data, SQL and NoSQL databases. |
    | GPU | NV, NC, NCv2, NCv3, ND | Specialized virtual machines targeted for heavy graphic rendering and viedo editing, as well as model training and inferencing (ND) with deep learning. Available with single or multiple GPUs |
    | High performance compute | H, A8-11 | Our fastest and most powerful CPU virtual machines with high-throughput network interfaces (RDMA). |

- **VM Disk Types**
  - **OS Disk**
    - ‚ùó Generation 1. VHD only
      - If you use Generation 2 Hyper-V you need to convert from `.vhdx` to `.vhd`.
    - Registered as SATA drive
    - ‚ùó Maximum capacity of 1 TB
  - **Data Disk**
    - Dependent # on VM instance size
    - Registered as SCSI disk
    - ‚ùó Max capacity 4 TB
  - **Temprorary Disk**
    - D: or /dev/sdb1
    - Bound to the hardware host
    - Do not store permanent data!

- **VM Storage**
  - ***Standard vs. Premium Disk Storage***
    - **Standard Disks**
      - Backed by cost-effective HDDs
      - High availability: several replication options
      - Stored in Azure storage account
      - Standard SSD (Preview) available for managed disks (dev/test/entry elvel production applications)
      - Standard storage provides maximum IOPS values for each VHD
      - On portal
        - You can see disks in Azure Disks.
        - Azure names managed disks like `dc1_data-disk1`, `dc1_OSDisk` for a VM named `dc`.
        - By clicking on it, you can manage the disk.
          - You can e.g. export, create a snapshot
    - **Premium Disks**
      - Backed by high-speed SSDs
      - IOPS values are predictable, expected performance levels
      - Pre-pay for all storage used (fixed sized disk sizes)
        - üí° Predictable speed and IOPS
        - P10, 128 GB, 500 IOPs, 50 MB/sec
      - ‚ùó Supports only Generation 1 VHD
        - If you use Generation 2 Hyper-V you need to convert from `.vhdx` to `.vhd`.
        - üí° Azure Site Recovery migration handles this automatically
        - On portal
          - You can see unmanaged disks in blob Containers -> vhds -> you see VHD's
          - A security problem is that someone by mistake can give public access to the blobs in the storage account.
  - ***Managed vs. unmanaged Disk Storage***
    - **Unmanaged Disks**
      - Original method to store VM VHDs
        - Legacy
      - VHDs are stored as page blobs in an Azure storage account
      - ‚ùó Maximum 256 TB of storage per VM
      - ‚ùó You need to manage storage account availability
      - ‚ùó 20,000 IOPS limit across all VM disks in a standard storage account
      - In storage account they're in Blob Containers -> vhds container.
        - They're leased
          - They a re locked
          - You need to stop & deallocate VM's to delete them
        - You can break lease in Storage Explorer by right clicking
    - **Managed Disks**
      - üí° Always use
      - Azure manages the disks, you don't have to worry about storage account-level IOPS restrictions.
      - Pre-pay for disk size (no need for SA)
        - S10, 128 GB, 500 IOPS, 60 MB/sec
      - Supports Standard and Premium SSD and Standard HDD
      - ‚ùó LRS replication only for Premium managed disks
      - ‚ùó You can resize only when they're unattached or owner VM is stopped & deallocated

- **VM Costs**
  - Use Azure Pricing Calculator
  - Optimizing costs
    - üí° Reserved Virtual Instances are the cheapest option.
      - You pay 1 to 3 year term for a particular VM instance size in aspecific region.
    - üí° Reuse on-prem Microsoft licensens, up to 49% discount
  - VM Chooser (`azurevmchooser.kvaes.be)
    - Open source applications to get recommendations
      1. Give total VCPUs, RAMs etc.
      2. Select a recommended VM
      3. VM optimizer: Choose usage patterns, region etc.

- **IP addressing**
  - You always have a private IP and you can optionally have a public IP
  - **Public IP addresses**
    - Best practice is to never have a public IP
      - Consider a load balancer to map the private IP.
    - First 5 public IPs are free then it costs
    - You have to NSG with an public IP
    - Public IPv4 addresses can be associated with:
      - VM vNICs, public load balancers, VPN gateways, and application gateways
    - Public IP Address SKUs
      - Basic SKU
        - Open by default
        - Static or dynamic allocation
      - Standard SKU
        - Secure by default (NSG)
        - Static allocation only
        - HA: Availability zone aware, can span to different availability zones
  - **DNS Naming**
    - For VM's you can configure & use host name
    - VM -> Overview -> Configure DNS Name then you can have like `somename.eastus2.cloudapp.azure.com`

- **High Availability**
  - High Availability = Redundancy
  - Layers of availability
    1. Hardware-level availability
        - Handled by Azure
    2. Server-level availability
        - **Availability Sets**
          - Ensures 99.95% SLA for VMs in availability set
          - Provides server level fault tolerance within a single data center within a single region.
          - Availabiliy sets are containers/racks that's called Fault Domains.
          - 2 VM's in same Availability Sets = Azure places those in different availability sets.
          - Update domains are different domains in different availability sets (fault Domains) and your VM's are set in different update domains as well.
            - Protects availability against VM shutdowns because of update failures / hardware shutdowns.
          - ‚ùó Must assign availability set at VM deployment
          - ‚ùó Scaling (resizing) requires stopping all VMs in the availability set.
          - For single VM not in availability set you have 99.9% availability if you use premium storage.
    3. Datacenter-level
        - **Availability Zones**
          - Allows you to place redundant VM's in different regions.
          - Provides data center level tolerance.
          - Load balancers are availability zone aware on standard SKU
          - ‚ùó You have to use managed disks
    4. Region-level
        - You need recovery service vault (storage for back-ups/replications)
          - **VM backup**
            - Ad-hoc or scheduled
            - Includes all disks and configurations
          - **Azure Site Recovery**
            - **Failover recovery**
              - 15 minute RPO (recovery point objective)
              - **Azure-to-Azure (A2A) ASR Architecture**
                - Directly available in VM blade
                - All storage data, VM's, disks (managed and unmanaged), subnets etc.
                  - Prepared and ready to go in another region.
                  - In sync
                  - ‚ùó May require configuration with IP addresses
                  - You can failover to it and/or failback
              - Configure in VM blade -> Disaster recovery
                - Allows you to configure disaster recovery for single VM
                  - For workloads including multiple VM's you should configure it directly from Site Recovery
                - You can choose to automate what happens using Automation rubooks.
                - You can then view recovery status in same blade
                  - Replication health
                  - Recovery points
                    - Crash-consistent:
                      - Least preferable
                      - As if VM is replicate while it was powered off, no guarantees
                    - App-consistent
                      - Preferable point to recover
                      - Data and OS back
                  - Commit -> Finalizes the failover
                  - Re-protected -> Creates new recovery environment from old recovery enviroment (which becomes source nevironment)
            - **Migration to Azure**
              - On-premises to Azure
              - AWS to Azure
  - **Azure Advisor**
    - Gives recommendation regarding high availability
    - E.g.:
      - Add more virtual machines for improved fault tolerance *(medium impact)*
      - Enable VM backup to protect your data from corruption and ccidental deletion *(medium impact)*
      - Create an Azure service health alert *(low impact)*
  - **VM events**
    - Planned maintenance events
    - Unexpected downtime events
    - Notification
      - In Azure support webpage, status webpage, twitter account
      - Administrators get e-mail notifications

- **VM Deployment**
  - Deployment tools: Azure portal, Azure Cloud Shell, Azure PowerShell, Azure CLI v2.0, Azure SDKs, ARM templates
  - You can create from
    - User images
      - Uses unmanaged disks
    - Marketplace images
  - **Create VM Image**
    - As first step, generalize VM
      - Generalization resets server-specific data:
        Computer name
        - Security identifiers (SIDs)
        - Local administrator/root identity
        - Device driver cache
        - Event logs
      - How to generalize
        - On Windows use sysprep, "System Preparation Tool"
        - On Linux run `sudo waagent -deprovision+user`
        - Take a VM backup first, because generalization is destructive and permanent
      - **Create VM image from Azure VM**
        - Managed Disk Concepts
          - Disks
            - No storage account (management) required
            - Pay for pre-allocated storage (P10 =128 GB SSD VHD)
          - Snapshots
            - Read-only full copy of a managed disks
            - You can create new VM's based on snapshots
          - Images
            - Generalized VM disk images
            - Snapshots can be converted into images
        - ***Flow***
          1. Get an image:
              - Get a snapshot image
                1. Go to Disks -> Select OS disk -> Create snapshot
                2. In snaphot -> Click on Export -> You'll get SAS url -> Download VHD
                3. Generalize the image
              - Or capture an image
                - VM -> Overview -> Capture
                - ‚ùó Not generalized
                - It appears in images
          2. Go to Images in portal, select the image, from there click on Deploy and it'll navigate you
  - **VM Connection**
    - You have different levels of security NSG, host firewall, options to have public IP or not
    - **Just-in-time VM Access**
      - Recommended to enable
      - Requires Azure Security Center Standard tier
      - Locks down all administrator ports as default, when admin requests admin session then session is bounded by time limit and IP address restriction while granting access.
      - No need to have management port open all the time
  - **Deploying Linux Server VM**
    - Around 40% of workloads in Azure runs on Linux
    - Endorsed in Azure: CentOS, CoreOS, Debian, Oracle Linux, Red Hat Enterprise Linux, SUSE Enterprise Linux, openSUSE, Ubuntu
    - Connection
      - **Secure Shell (SSH)**
        - A popular client is PuTTy for SSH or you can install *subsystem for Linux* or *git tools* on Windows 10 to get SSH.
      - **Remote Desktop Protocol (RDP)**
        - You can install RDP on Linux.
        - Some do not believe in graphical shell:
          - Presents security vulnerability possible
          - Needlessly consumes CPU
        - Windows team ported RDP into linux.
      - **Serial Console**
        - COM1 serial port connection to VM
        - Low-level access
        - Helpful when e.g. your VM doesn't boot up
    - **Authentication**
      1. SSH Public Key
          - You keep private key and share public key with Azure.
      2. Password
      - You can reset those after deployment in VM -> Reset password
  - **Deploying Windows Server VM**
    - Windows Server 2019, 2016, 2012, 2008, Windows 10 Pro or Enterprise (for e.g. load testing, client-side testing, jump-box)
    - **Connect**
      - Remote Dekstop Protocol (RDP)
        - Uses TCP 3389
        - You can connect directly from Overview -> Connect
      - WinRM (PowerShell) Remoting
        - TCP 5985, 5986
      - Serial Console
        - Text console into VM
        - Can get to VM's that can't boot
  - **Prepare environment with Azure Policy**
    - **RBAC vs Azure Policy**
      - RBAC
        - Focuses on user actions at different scopes
        - VM Contributor can manage only VM
        - Built-in custom roles
      - Azure Policy
        - Focuses on resource properties during deployment for already existing resources
        - Uses default allow and explicit deny access system
      - Difference
        - You're not going to be able to create VM unless you have read & write abilities by RBAC
        - Azure Policy in contrast constrains what that RBAC can do when she/he attempts to create VM
    - Some built-in Azure Policy definitions are e.g. *allowed locations*, *VM SKU*, *ensure MMS extension is deployed*
    - You can create also own policies, or initiatives which are collections of policies.
    - Example:
      - Policy -> Assign Policy
      - Policy defination: E.g. allowed locations
      - Parameters: Select which regions are allowed
  - **Deploy with ARM templates**
    - ARM templates are infrastructure as code foundation of automation and DevOps in Azure
    - üí° Visual Studio is a good ARM template editor
      - Visual Studio Code can also be used.
    - Different ways to work with templates
      1. You can go to Portal -> Templates -> Usage existing usages or add a new template
      2. In Visual Studio -> Cloud -> Azure Resource Group -> You can select template location (e.g. github) -> Select a template
      3. Deploy a VM then in the last step click on "Download template and paremeters"
    - You can deploy with PowerShell, Cloud Shell, Azure CLI, or directly from Visual Studio
    - You can automate deployment actions such as VM access
    - Files
      - `azuredeploy.json`
        - Deployment template.
        - Defines resources and property such as `Allowedvalues`, `defaultvalues`
        - You can refactor some values in variables and reuse in the file
        - `copy` element block in deployment script allows you to create e.g. 3 storages.
      - `azuredeploy.parameters.json`
        - Deployment parameters (required for deployment) to depoy `azuredeploy.json`

- **VM Scale Sets (VMSS)**
  - Group that holds identically configured VM's
  - Used for
    - Need to create and manage multiple VMs
      - Centrally create and manage multple VMs (Windows Server or Linux)
    - Need for high availability and app resiliency
      - Horizontal scaling, scaling up and down based on spikes
    - Need for large (1000) scale
      - E.g. Azure Batch uses scale sets under the hood
    - Need for IaaS autoscale
      - Scale out and in based on metrics based autoscale
  - ***PaaS Scaling vs IaaS Scaling***
    - Azure App Service
      - High agility at the expense of administrative power
      - The underlying Hyper-V Vms are almost totally abstracted from you
      - Easy manual, scheduled, or automatic scale out and scale back
    - Virtual Machine Scale Set (VMSS)
      - Maximum administrative power at the expense of agility
      - VMSS represents Azure's approach to IaaS horizontal scaling
  - ***Deploying a VM Scale Set***
    - Create virtual machine scale set
      - Availability zone
        - Scale scale sets across one and more availability zones
        - ‚ùó All regions do not support availability zone
      - Instance count & instance set
      - Low priority
        - Take advantage of unutilized capacity
          - Compute power that customers/Microsoft is not using
          - Save costs
        - Good for workloads that can handle interruption
          - Stateless workloads
          - VMs in the scale set may be evicted at any time
          - You set eviction policy:
            - Stop / Deallocate
            - Delete
      - Use manage/unmanaged disks
        - ‚ùó Managed disks are not supported with availability zones
      - Networking
        - Application Gateway
          - üí° Useful if your scale sets are web servers
          - ‚ùó Do not support RDP
        - Load Balancer
          - Supports RDP
          - You set public IP address name and domain name label (`domain-name.region.cloudapp.azure.com`)
    - You can also use ARM template e.g. *Deploy a Windows VM Scale Set with  a Custom Script Extension* that deploys VM's, load balancer and a powershell script to be executed after deployment.
  - ***Connecting to VM's***
    - In Settings -> Instances you can see all the instances
    - To connect to individual instances you need load balancer and NAT (network address translation)
      - You can't RDP/SSH into individual instances directly
      - You can connect to load balancer IP's (see in Load Balancer -> Inbound NAT rules)
      - NAT maps different VM's on different ports.
  - ***Configuring Autoscale***
    - ***Manual***: Through Portal/SDK/CLI/PowerShell
    - Autoscale
      - ***Scheduled***: If you know when the load will be high you can plan for that and scale with time triggers
      - ***Metrics***: Use various metrics from various sources to determine when to scale in/out
      - Manage in VMSS -> Scaling ->
        - Enable auto-scaling
        - Select scale-mode
          - ***Scale based on metric***
            - Add rule
              - E.g. increase instance count by 1 when CPU procentage above 70%
              - üí° You should also create scale mode that bringd down the scale count
              - Properties
                - Duration: Good to not be confused when scaling out/in, so set a duration to e.g. 10 minutes
                - Cooldown: Waits after scale operation before new scale operation
          - ***Scale to specific instance count***
            - Time-based scaling
            - Set start and end date
  - ***Load Balancer Options***
    - All load balancers are software appliances (software defined networking SDN)
    - üí° Only Standard (not Basic) SKU allows availability zones in Load balancer
    - Options:
      - **Public load balancer**
        - OSI Layer 4 TCP and UDP
        - Internet-facing, has public IP address
        - Offers two distribution modes
        - ***Set-up public load balancer***
          1. Settings -> Back-end-pools-> Add VM's
          2. Settings -> Health-probe -> Add health probe
              - E.g. tcp-80-probe (HTTP) probe
              - Set interval -> time between prop events
              - Set unhealth threshold (e.g. 2) before VM is dropped out from the pool
              - Add load balancing port
                - Incoming request from port 80 (*port*) will be passed to TCP passed 80 (*back-end port*)
                - Select backend pool & health-probe
                - Set session persistance
                - Floating IP (direct server return)
                  - Use with internal load balancers
                  - Use with SQL server always on cluster
                  - Used when same back-end port needs to be used across multiple rules in a single Load Balancer.
          3. Add inbound NAT rule
                - Map TCP 5000 to a VM's RDP port (3389)
                - Map TCP 5000 to a VM's RDP port (3389)
      - **Internal load balancer**
        - OSI Layer 4 TCP and UDP
        - Applies to traffic only within a virtual network
          - No public IP address
        - Good for applying load balancing to n-tier application services (database)
      - **Application Gateway**
        - OSI Layer 7 application
        - Application Delivery Controller (ADC) as a service
        - SSL offload
        - Has Web Application Firewall (WAF)
      - **Traffic Manager**
        - DNS-level
        - Geographical load balancing
        - Offers different routing methods

- **Monitoring**
  - **Boot diagnostics**
    - Periodic screenshots of the console
    - Enables serial console
      - You can connect to VM when you can't SSH/RDP for fixing e.g. boot state
      - Requires you to have VM Contributor or higher privileges.
      - No need to open SSH/RDP ports
  - **Guest OS diagnostics**
    - Requires storage account
    - Event logs, performence counters etc.
    - Lowest level IaaS monitoring extension
    - For more diagnostics:
      - Windows: AzurePerformanceDiagnostics
      - Linux: Linux Diagnostic Extension (LAD) 3.0
  - **Azure Log Analytics**
    - Enabled by deploying the Microsoft Management Extension
    - Onboards VMs into Log Analytics workspace
  - **System Center Operations Manager (SCOM)**
    - Hybrid cloud approach
    - You can track your cloud VM's on on-premises or visa versa

- **VM Security**
  - **Role based access control**
    - Provides fine-grained access to resources
    - AAA
      - A -> Authentication (identity)
      - A -> Authorization (abilities)
      - A -> Accounting (auduting)
    - Higher to lower granularity: Subscription -> Resource group -> Resource
    - Roles
      - Reader: Observers
      - Resource-specific or custom role, contributor: Users managing resources
      - Owner: Admins
    - Custom roles are defined in JSON
    - RBAC focuses on user actions at differen scopes.
      - By contrast, Azure Policy focuses on resource properties during deployment
        - Policies e.g. *Allowed virtual machine SKUs*, *Enforce automatic OS upgrade with app health checks on VMSS*
    - You can manage in *Access Control (IAM)* blade.
  - **Storage security**
    - **Storage Service Encryption**
      - Protects data at rest in storage account
      - 128-bit AES encryption
      - Azure manages encryption keys
        - üí° You can manage them yourself with Azure Key vault
    - **Azure Disk Encryption**
      - BitLocker for Windows Server VMs
      - DM-Crypt library for Linux VMs
      - Protects OS and data disks
      - Azure- or customer- managed disks
      - Manage:
        - In VM blade -> Disks -> Add data disk
        - Use powershell
          1. Create key vault and vault key
          2. Create security principal (identity in Azure AD) that can take the key from key vault
          3. You run `SetRmVMDiskEncryption` to configure encryption
  - **Network-level security**
    - **Network Security Group (NSG)**
      - Stateful firewalls
      - Augmented security rules: Have inbound/outbound rules
      - Can be bound to *public addresses*, *load balancers*, *subnets* and *VM*s.
      - Traffic streams are identified with 5-tuple hash: Source, destination, port, protocol, IP addresses.
      - Source can be service tags
        - In-built e.g. Internet
      - Or custom (**Application Security Group** identifiers)
        - Simplifies NSG's
        - Logically groups VM's e.g. by role
          - Association is done through NICs
        - E.g. AppServers, DatabaseServers
        - Flow:
          1. Define ASGs
          2. Include ASGs in NSGs
    - **Host Firewalls**
      - E.g. Windows Defender Firewall on Windows Server VM's
      - üí° A range that's whitelisted in NSG can be blocked by host firewalls.
    - **Jumpbox Architecture**
      - Jumpbox is a pivot point VM in a VNet
      - Good for auditing every administrative action
        - A shared jumpbox makes it easier to administrate the orchestration
      - You can e.g. allow access to public IP and make sure it's locked down to that endpoint.
      - Or you can e.g. point to Site-to-Site VPN or point-to-site VPN.
  - **Azure Security Center (ACS)**
    - Centralizes security policy management
    - Continuous security assesment
    - Actionable recommendations
    - Prioritized alerts and incidents
    - Integrated security solutions
      - E.g. recommends to deploy WAF
    - **Just-in-Time (JIT) VM Access**
      - Normaly to access a VM, you need 3389 for RDP protocol, or 22 to SSH for linux, you open those ports 7/24.
        - Not so secure as they're publically accesible if IP is public.
      - JIT locks down inbound administrative port access
      - Time-restricted access to specific IP address(es)
      - Requires Azure Security Center standard

- **VM Backups**
  - **VM Disk Snapshots**
    - .VHD files (data + os disks in page blobs) are stored aas page blobs.
    - Full and incremental point-in-time snapshots
      - Faster than performing full back-ups
        - üí° The difference is that snapshots are deltas
    - Supported in
      - Managed disks
      - Unmanaged disks
        - Use AzCopy command line tool to archive to another storage account
    - ‚ùó Snapshots cannot outlive their sources blob
      - If you delete VM's, snapshots become irrelevant
        - üí° Consider archiving them
    - You can create new VM from a snapshot.
    - In Portal -> VM -> Disks -> Select Disk -> Create Snapshot
      - In Snaphots -> Find snapshot ->
        - Export:
          - You export with creating SAS URL (time limited)
          - You get direct URL
  - **Azure VM Backup**
    - **MARS, Microsoft Agent Recovery Services**
      - Supports on-prem to cloud
      - Supports file/folders but not whole disk back-up
    - **System Center DPM (Data Protection Manager)**
      - Supports system image/whole VM back-ups from on-premises to Azure
    - **Azure Backup Server (MABS, Microsoft Azure Backup Server)**
      - Azure specific version of System Center DPM
    - **Azure Backup**
      - Azure IaaS VM Backup
      - Require recovery services vault
        - Don't need to worry about storage accounts
      - Azure Backup service uses VMSnapshot and VMSnapshotLinux extensions
      - VSS orchestrates consistent snapshots of OS and data disks.
      - **Consistency Levels**
        - **Application-consistent**
          - üí° Preferred backup type
          - Data is consistent with time of backup (VSS)
        - **File-system consistent**
          - Ensures the VM boots and there is neither corruption nor data loss
          - You may need to take further action to bring data current
        - **Crash-consistent**
          - Least preferred backup type
          - Used when you back up a powered down VM
      - **Manage**
        - VM -> Backup ->
          - Create/select recovery services vault
          - Create back-up policy with backup frequency and retention range
        - You can see/start/stop back-ups in Recovery Services vault -> Backup Items
          - You can create policies in Backup Policies blade.
        - In back-up/replication jobs blade you can list all jobs
      - Restoring VMs
        - **Restore options**
          - **Create a new VM**
            - Basic VM up and running from a restore point
          - **Restore disk**
            - Restores a VM disk which can then be used to create a new VM.
            - Azure Backup provides a template to help you customize and create a VM.
            - Useful if you want to customize the VM, add configuration settings that weren't there at the time of backup, or add settings that must be configured using the template or PowerShell.
          - **Replace existing**
            - You can restore a disk, and use it to replace a disk on the existing VM.
            - Supported for unencrypted managed VMs
            - ‚ùó Not supported for unmanaged disks, generalized VMs, or for VMs created using custom images.
        - **Recovery Options**
          - **Entire VM**
            - OS and data disks
            - Configuration
            - Restore to original or alternate location
            - Quick create option
            - ***Flow***: Recovery Services Vault -> Restore VM -> Restore type: Create VM
          - **Individual Disks**
            - Restore to storage account
            - Includes ARM deployment template
            - üí° Use to control VM restore, gain full control over the VM environment
              - Availability set
              - vNIC
              - IP addresses...
            - ***Flow***
              1. Recovery Services Vault -> Restore VM -> Restore type: disks
              2. Restore VHD(s) to storage account
              3. Create VM configuration
              4. Attach the OS and data disks
          - **Files and Folders**
            - Mount OS and data disks as network drives
            - **Azure VM File Recovery**
              - E.g. "We need to retrieve a few log files from 3 months ago. Time is of the essence"
                - If it was a VM back-up, it'd be costly as it takes storage etc.
                - With file recovery you can only recover log folders
              - ***Workflow***
                - Select recovery point
                - Download and run PowerShell script
                - Recover file system
                - Unmount the disks after recovery
              - Manage in Recovery Service Vault -> File Recovery
  - **Failover Recovery for VMs**
    - Continuity/disaster recovery
    - **Azure Site Recovery**
      - Replication/orchestration engine
      - You can use cloud <=> cloud, on-prem <=> cloud, on-prem <=> on-prem
      - Provides region levl failover
      - Physical and virtual (Hyper-V and/or VMware) machines are supported
      - Azure as a recovery site
      - Migrate to Azure
      - Manage in *VM -> Disaster Recovery* or *Recovery Services vault -> Site Recovery* (or *Recovery Services vault -> Disaster Recovery* especially for VM's)
        - Select target region
        - Select target resources (e.g. VNEt, availability set, RG) to new resources or existing
        - You can set storage, replication and extension settings
        - With a **recovery plan** you can set recovery order, inject code in-between VM's
          - You need to do it Recovery services vault
      - **Failover/Failback**
        - In VM -> Disaster Recovery ->
          - Select Test failover or Failover
          - Click on "Commit"
          - Re-protect -> Go back to the original location
        - Flow:
          1. Prerequisite check
          2. Failover
          3. Create recovery point
          4. Start the VM
          5. Clean-up resources